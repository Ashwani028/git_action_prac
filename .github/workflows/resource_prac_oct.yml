name: "creat new rg practise"
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main



permissions:
  id-token: write
  contents: read

jobs:
  terraform_init_plan:
   runs-on: self-hosted
   
   steps:
     - name: My first step terraform_init_plan
       run: echo First_Step
     - name: Checkout
       uses: actions/checkout@v5.0.0
     - name: Azure Login
       uses: Azure/login@v2.3.0
       with:
          client-id: "b0151d1f-06be-43a6-9869-0ceef94ce1a5"
          tenant-id: "57464fa0-05a4-4855-a9af-e5be611b8553"
          subscription-id: "635e9286-14d1-435f-b7e1-af1ebf689f4e"
       
     - name: Terraform fmt
       working-directory: "./RG"
       id: fmt
       run: terraform fmt -check
       continue-on-error: true
     - name: Terraform Init
       working-directory: "./RG"
       id: init
       run: terraform init -input=false
     - name: Terraform Validate
       working-directory: "./RG"
       id: validate
       run: terraform validate -no-color
     - name: Terraform Plan
       working-directory: "./RG"     
       id: plan
       run: terraform plan -no-color -input=false
       continue-on-error: true

        
  terraform_SCAN:
      runs-on: self-hosted
      needs: terraform_init_plan

      steps:
      - name: Terraform_SCAN_tfsec
        run: echo Second_Step

      - name: Checkout
        uses: actions/checkout@v5.0.0

      - name: Download tfsec binary (Windows)
        shell: powershell
        run: |
          Invoke-WebRequest -Uri https://github.com/aquasecurity/tfsec/releases/latest/download/tfsec-windows-amd64.exe -OutFile tfsec.exe

       

  terraform_init_apply:
   runs-on: self-hosted
   needs: terraform_SCAN
   
   
   if: github.ref == 'refs/heads/main'  # âœ… This ensures the job only runs on the main branch   

   steps:
      - name: My first step terraform_init_plan
        run: echo First_Step
      - name: Checkout
        uses: actions/checkout@v5.0.0
      - name: Azure Login
        uses: Azure/login@v2.3.0
        with:
          client-id: "b0151d1f-06be-43a6-9869-0ceef94ce1a5"
          tenant-id: "57464fa0-05a4-4855-a9af-e5be611b8553"
          subscription-id: "635e9286-14d1-435f-b7e1-af1ebf689f4e"

      - name: Terraform Init
        working-directory: "./RG"
        id: init
        run: terraform init -input=false

      - name: Terraform apply
        working-directory: "./RG"
        id: apply
        run: terraform apply --auto-approve
        continue-on-error: true
  
